<!DOCTYPE html>
<!--
/*
 * The contents of this file are subject to the terms of the Common Development and
 * Distribution License (the License). You may not use this file except in compliance with the
 * License.
 *
 * You can obtain a copy of the License at legal/CDDLv1.0.txt. See the License for the
 * specific language governing permission and limitations under the License.
 *
 * When distributing Covered Software, include this CDDL Header Notice in each file and include
 * the License file at legal/CDDLv1.0.txt. If applicable, add the following below the CDDL
 * Header, with the fields enclosed by brackets [] replaced by your own identifying
 * information: "Portions Copyrighted [year] [name of copyright owner]".
 *
 * Copyright Â© 2013 ForgeRock AS. All rights reserved.
 */
-->
<html>
<head>
    <title>Autocomplete</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
    <script type="text/javascript" src="common.js"></script>
    <script type="text/javascript">
        // Return base URL of demo.
        function getDemoBase() {
            return window.location.href.substring(
                    0, window.location.href.lastIndexOf('/'));
        }

        function getJSON(file) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', getDemoBase() + "/" + file, false);
            xhr.send("");

            var response = "";
            if (xhr.status === 200) { // OK
                response = xhr.responseText;
            }
            return response;
        }

        // Use the common REST API to provision from a JSON file to a container.
        // Calling this repeatedly should cause a bunch of HTTP 409 Conflicts.
        function provision(file, container) {
            var collection = JSON.parse(getJSON(file));
            for (var i = 0; i < collection.length; i++) {
                var myObject = collection[i];
                var resource = container + "/" + collection[i].id;
                var result = create(myObject, resource);
            }
        }

        // Capitalize first letter.
        String.prototype.capitalize = function () {
            return this.charAt(0).toUpperCase() + this.slice(1);
        };

        // Return a <tr> with <th> for each field of an object.
        function getHeaderRow(object) {
            var cells = "";
            for (var prop in object) {
                cells = cells + "<th>" + prop.capitalize() + "</th>";
            }
            return "<tr>" + cells + "</tr>";
        }

        // Return a <tr> with <td> for each field of an object.
        function getDataRow(object) {
            var cells = "";
            for (var prop in object) {
                cells = cells + "<td>" + object[prop] + "</td>";
            }
            return "<tr>" + cells + "</tr>";
        }

        // Build and return a table of objects such as users or groups.
        function getTable(objects) {
            if (objects.length == 0) { return ""; }

            var rows = getHeaderRow(objects[0]);
            for (var i = 0; i < objects.length; i++) {
                rows = rows + getDataRow(objects[i]);
            }
            return "<table>" + rows + "</table>";
        }

        $(function() {
            $("#users").autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: "/json/users",
                        dataType: "json",
                        data: "_filter=displayName co \"" + request.term + "\"&_fields=displayName,_id",
                        success: function(data) {
                            response($.map(data.result, function(item) {
                                return {
                                    label: item.displayName,
                                    value: item.displayName,
                                    id: item._id
                                }
                            }));
                        }
                    });
                },
                select: function(event, ui) {
                    var resource = "/json/users/" + ui.item.id;
                    var queryString = "?_fields=displayName,userName,password";
                    var user = JSON.parse(read(resource + queryString));
                    $("#log").html(getTable([user]));
                }
            });
            $("#groups").autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: "/json/groups",
                        dataType: "json",
                        data: "_filter=displayName co \"" + request.term + "\"&_fields=displayName,_id",
                        success: function(data) {
                            response($.map(data.result, function(item) {
                                return {
                                    label: item.displayName,
                                    value: item.displayName,
                                    id: item._id
                                }
                            }));
                        }
                    });
                },
                select: function(event, ui) {
                    var resource = "/json/groups/" + ui.item.id;
                    var queryString = "?_fields=displayName,members";
                    var group = JSON.parse(read(resource + queryString));
                    $("#log").html(getTable([group]));
                }
            });

            $( "#tabs" ).tabs();

            provision("SCIMUsers.json", "/json/users");
            provision("SCIMGroups.json", "/json/groups");
        });
    </script>
    <style type="text/css">
        table {
            border: 1px solid black;
            border-collapse: collapse;
            font-size: small;
            margin: 20px;
        }
        th, td {
            border: 1px solid black;
            margin: 5px;
            padding: 5px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #808080;
            color: white;
        }
    </style>
</head>
<body>
<h1>Autocomplete</h1>
<div id="tabs">
    <ul>
        <li><a href="#user-sect">Users</a></li>
        <li><a href="#group-sect">Groups</a></li>
    </ul>

    <div id="user-sect">
        <label for="users">Users</label>
        <input id="users" />
    </div>

    <div id="group-sect">
        <label for="groups">Groups</label>
        <input id="groups" />
    </div>
</div>

<div id="log"></div>
</body>
</html>
